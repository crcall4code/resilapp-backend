{% extends "base.html" %}
{% block title %}
    Comunidades
{% endblock %}
{% block head %}
    {{ super() }}
    <style>

    </style>
{% endblock %}
{% block body %}
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Comunidades</h1>
    </div>

    <!-- Content Row -->
    <div class="row">
        <div class="container" id="container">
            <h1>Bienvenido</h1> <!- Welcome ->
            <div id="communityInput" class="input-group-lg">
                <p class="lead">Indique su comunidad</p>
                <table>
                    <tr>
                        <td><p class="lead"></p>Provincia</td>
                        <td><p class="lead"></p>Canton</td>
                        <td><p class="lead"></p>Poblado</td>
                    </tr>
                    <tr>
                        <td><select id="state-select" class="js-data-example-ajax">PROVINCIA</select></td>
                        <td><select id="city-select" class="js-data-example-ajax"></select></td>
                        <td><select id="community-select" class="js-data-example-ajax"></select></td>
                    </tr>
                </table>
                <button id="search" type="button" class="btn btn-primary">Buscar Comunidad</button>
                <button id="create_community" type="button" class="btn btn-success" disabled>Guardar Comunidad</button>
                <button id="reload" type="button" class="btn btn-warning">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <table>
                <tr>
                    <td>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Comunidad</span>
                            </div>
                            <input id="community-name" type="text" size="50" class="form-control"
                                   placeholder="Comunidad">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">ID</span>
                            </div>
                            <input id="town-id" type="text" size="50" class="form-control" placeholder="ID">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Etapa</span>
                                <input id="community-stage" min="1" type="number" size="20" class="form-control" placeholder="Etapa">
                            </div>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text">Paso</span>
                                <input id="community-step" min="1" type="number" size="20" class="form-control"
                                   placeholder="Paso">
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <h4 class="small font-weight-bold">
                            Progreso de etapa
                            <span class="float-right" id="stage-progress">
                                100%
                            </span>
                        </h4>
                        <div class="progress mb-4">
                            <div id="stage-progress-bar" class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <h4 class="small font-weight-bold">
                            Progreso total
                            <span class="float-right" id="total-progress">
                                100%
                            </span>
                        </h4>
                        <div class="progress mb-4">
                            <div id="total-progress-bar" class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100"
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <h4 class="small font-weight-bold">
                            Pasos/Indicadores
                            <span class="float-right" id="step-progress">
                                50%
                            </span>
                        </h4>
                        <div class="progress mb-4">
                            <div id="step-progress-bar" class="progress-bar" role="progressbar" style="width: 50%" aria-valuenow="50"
                                 aria-valuemin="0" aria-valuemax="25">
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="community-id" style="display: none;">
                            <input id="community_id" type="text" class="form-control">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="community-rev" style="display: none;">
                            <input id="community_rev" type="text" class="form-control">
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script
            src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous" type="text/javascript"></script>
    <script src="{{ url_for('static', filename = 'antixss.js') }}" type="text/javascript"></script>

    <script>
        var community = {};
        {% if province %}
            community.state = "{{ province }}";
            community.city = "{{ canton }}";
            community.town = "{{ community }}";
        {% endif %}
        console.log(community);

        $(document).ready(function () {
            if ($.isEmptyObject(community)) {
                getProvinces();
            } else {
                $('#state-select').append(new Option(community.state));
                $('#city-select').append(new Option(community.city));
                $('#community-select').append(new Option(community.town));
            }
            $('#community-name').val("");
            $('#town-id').val("");
            $('#community-stage').val("");
            $('#community-step').val("");
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            $.get(baseUrl + "/api/resilience/stages_count")
                .done(function (data) {
                    $('#community-stage').attr("max", String(data.Stages_count));
                });
        });

        var steps_by_stage;
        function get_steps_by_stage(){
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            $.get(baseUrl + "/api/resilience/steps_count_by_stage/")
                .done(function (data) {
                    steps_by_stage = data.Steps_count_by_stage;
                });
        };
        get_steps_by_stage();

        $('#community-stage').change(function () {
            let stage_number = $('#community-stage').val();
            $('#community-step').attr("max", String(steps_by_stage[stage_number]));
        });

        function getProvinces() {
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            $.get(baseUrl + "/api/towns/provinces")
                .done(function (data) {
                    if (data != null) {
                        $('#state-select').append(new Option("Provincia:", "", true, true));
                        data.forEach(function (element) {
                            $('#state-select').append(new Option(element));
                        });
                    }
                });
        }

        $('#reload').click(function () {
            var getUrl = window.location;
            var baseUrl = getUrl.protocol + "//" + getUrl.host + "/" + getUrl.pathname.split('/')[1];
            window.location.href = baseUrl;
        });

        //Change page to create a community with its resilience details
        $('#create_community').click(function () {
            let town = $('#community-select').val();
            let city = $('#city-select').val();
            let state = $('#state-select').val();
        });

        //Submit data when search button is pressed
        $('#search').click(function () {
            let town = $('#community-select').val();
            let city = $('#city-select').val();
            let state = $('#state-select').val();
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            let communities_url = baseUrl + "/api/communities/";
            let community_url = communities_url.concat(state, "/", city, "/", town);
            if (state.length > 0 && city.length > 0 && town.length > 0) {
                $.get(community_url, function (data) {
                    console.log(data);
                    if (data != null) {
                        let community_name = data.PUEBLO;
                        $('#community-name').val(community_name);
                        $('#town-id').val(data.POBLAC_ID);
                        $('#create_community').removeAttr('disabled');
                        $('#community-stage').val(data.RESILIENCIA.stage);
                        $('#community-step').val(data.RESILIENCIA.step);
                        $('#total-progress').html(data.RESILIENCIA.resilience_total_level+"%");
                        let total_progress_width = "width:"+ data.RESILIENCIA.resilience_total_level + "%";
                        $('#total-progress-bar').attr({
                            "style":total_progress_width,
                            "aria-valuenow":String(data.RESILIENCIA.resilience_total_level)
                        });
                        $('#stage-progress').html(data.RESILIENCIA.resilience_stage_level+"%");
                        let stage_progress_width = "width:"+ data.RESILIENCIA.resilience_stage_level + "%";
                        $('#stage-progress-bar').attr({
                            "style":stage_progress_width,
                            "aria-valuenow":String(data.RESILIENCIA.resilience_stage_level)
                        });
                        let badges_number = data.RESILIENCIA.badges.length;
                        let getUrl = window.location;
                        let baseUrl = getUrl.protocol + "//" + getUrl.host;
                        $.get(baseUrl + "/api/resilience/steps_count").done(function (data) {
                            let total_steps = String(data.Steps_count);
                            $('#step-progress').html(badges_number+"/"+total_steps);
                            $('#step-progress-bar').attr({
                                "style":total_progress_width,
                                "aria-valuemax":total_steps,
                                "aria-valuenow":String(badges_number)
                                });
                        });
                    } else {
                        $('#community-name').val('Community not found');
                    }
                });
            } else if (state == "Provincia:" || city == "Cantón:" || town == "Poblado:") {
                $('#state-name').empty();
                $('#city-name').empty();
                $('#town-name').empty();
                $('#town-id').empty();
            }
        });
        $('#state-select').change(function () {
            $('#community-select').empty();
            $('#city-select').empty();
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            $.get(baseUrl + "/api/towns/" + $('#state-select option:selected').val())
                .done(function (data) {
                    if (data != null) {
                        $('#city-select').append(new Option("Cantón:", "", true, true));
                        data.forEach(function (element) {
                            $('#city-select').append(new Option(element));
                        });
                    }
                })
        });
        $('#city-select').change(function () {
            $('#community-select').empty();
            let getUrl = window.location;
            let baseUrl = getUrl.protocol + "//" + getUrl.host;
            $.get(baseUrl + "/api/towns/"
                + $('#state-select option:selected').val()
                + '/'
                + $('#city-select option:selected').val())
                .done(function (data) {
                    if (data != null) {
                        $('#community-select').append(new Option("Poblado:", "", true, true));
                        data.forEach(function (element) {
                            $('#community-select').append(new Option(element));
                        });
                    }
                })
        });
    </script>
{% endblock %}